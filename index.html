<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Newton's Law Pro Lab</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: system-ui; background: #121212; color: white; padding: 15px; }
        .card { background: #1e1e1e; padding: 20px; border-radius: 12px; margin-bottom: 15px; }
        .tabs { display: flex; gap: 10px; margin-bottom: 20px; }
        .tabs button { flex: 1; padding: 12px; background: #333; color: #999; border: none; cursor: pointer; border-radius: 8px; }
        .tabs button.active { background: #00d1b2; color: white; border: 2px solid white; }
        .btn-arm { background: #ffdd57; color: black; padding: 15px; font-size: 1.1em; width: 100%; border-radius: 8px; font-weight: bold; cursor: pointer; border: none; margin: 10px 0; }
        .btn-csv { background: #4a4a4a; color: white; border: none; padding: 8px; border-radius: 5px; cursor: pointer; }
        .stats-box { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin: 15px 0; background: #252525; padding: 15px; border-radius: 8px; border-left: 5px solid #ffdd57; }
        .stat-val { font-size: 1.2em; font-weight: bold; color: #ffdd57; }
        table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        th, td { border: 1px solid #333; padding: 8px; text-align: center; }
    </style>
</head>
<body>

<div class="card">
    <h2>Force & Acceleration Lab</h2>
    <button style="background:#00d1b2; color:white; border:none; padding:10px; border-radius:5px;" onclick="connectBLE()">Connect BLE</button>
    <span id="status"> ðŸ”´ Disconnected</span>
</div>

<div class="card">
    <div class="tabs">
        <button id="tabF" class="active" onclick="setMode('force')">Vary Force</button>
        <button id="tabM" onclick="setMode('mass')">Vary Mass</button>
    </div>
    <label id="inputLabel">Applied Force (N):</label>
    <input type="number" id="manualInput" value="1.0" step="0.1" style="width:60px; padding:5px;">
    
    <button class="btn-arm" onclick="sendCommand('ARM')">READY: Arm for Next Reading</button>
</div>

<div class="card">
    <div class="stats-box">
        <div>Slope: <div id="statSlope" class="stat-val">0.000</div></div>
        <div>RÂ² Fit: <div id="statR2" class="stat-val">0.000</div></div>
    </div>
    <canvas id="physicsChart"></canvas>
    <div style="margin-top:20px; display:flex; justify-content: space-between;">
        <button class="btn-csv" onclick="exportCSV()">Download CSV</button>
        <button class="btn-csv" style="background:#ff3860" onclick="clearData()">Clear Data</button>
    </div>
    <table>
        <thead>
            <tr><th id="colH">Force (N)</th><th>Accel (m/sÂ²)</th><th id="calcH">Calc Mass</th><th>Action</th></tr>
        </thead>
        <tbody id="dataBody"></tbody>
    </table>
</div>

<script>
    let commandChar, mode = 'force', dataPoints = [];
    const SERVICE_UUID = "19b10000-e8f2-537e-4f6c-d104768a1214";
    const DATA_UUID = "19b10001-e8f2-537e-4f6c-d104768a1214";
    const CMD_UUID = "19b10002-e8f2-537e-4f6c-d104768a1214";

    async function connectBLE() {
        try {
            const device = await navigator.bluetooth.requestDevice({ filters: [{ name: 'NanoPhys_S3' }], optionalServices: [SERVICE_UUID] });
            const server = await device.gatt.connect();
            const service = await server.getPrimaryService(SERVICE_UUID);
            const dataC = await service.getCharacteristic(DATA_UUID);
            commandChar = await service.getCharacteristic(CMD_UUID);
            document.getElementById('status').innerText = " ðŸŸ¢ Connected";
            await dataC.startNotifications();
            dataC.addEventListener('characteristicvaluechanged', (e) => {
                const val = new TextDecoder().decode(e.target.value);
                const [v1, v2, accel] = val.split(',').map(Number);
                const manual = parseFloat(document.getElementById('manualInput').value);
                const xVal = mode === 'force' ? manual : (1/manual);
                dataPoints.push({ id: Date.now(), x: xVal, y: accel, raw: manual });
                updateDisplay();
            });
        } catch (e) { alert(e); }
    }

    async function sendCommand(cmd) {
        if (commandChar) await commandChar.writeValue(new TextEncoder().encode(cmd));
    }

    function exportCSV() {
        let csv = "X_Value,Acceleration,Original_Input\n";
        dataPoints.forEach(p => { csv += `${p.x},${p.y},${p.raw}\n`; });
        const blob = new Blob([csv], { type: 'text/csv' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.setAttribute('href', url);
        a.setAttribute('download', 'physics_data.csv');
        a.click();
    }

    function setMode(m) {
        mode = m; 
        dataPoints = [];
        document.getElementById('tabF').className = mode === 'force' ? 'active' : '';
        document.getElementById('tabM').className = mode === 'mass' ? 'active' : '';
        document.getElementById('inputLabel').innerText = mode === 'force' ? "Applied Force (N):" : "System Mass (kg):";
        updateDisplay();
    }

    // (Regression and Chart logic remain similar to previous version for brevity)
    function updateDisplay() {
        const body = document.getElementById('dataBody');
        body.innerHTML = "";
        dataPoints.forEach(p => {
            body.insertAdjacentHTML('afterbegin', `<tr><td>${p.raw}</td><td>${p.y.toFixed(3)}</td><td>${(p.raw/p.y).toFixed(3)}</td><td><button onclick="dataPoints=dataPoints.filter(i=>i.id!==${p.id});updateDisplay()">X</button></td></tr>`);
        });
        // Call your chart and stats update functions here...
    }
    function clearData() { dataPoints = []; updateDisplay(); }
</script>
</body>
</html>
